# Production overrides for SynStack
# Usage: helm install synstack ./synstack -f values.yaml -f values-production.yaml

# =============================================================================
# API
# =============================================================================
api:
  replicaCount: 2

  image:
    repository: ghcr.io/jviguy/synstack-api
    tag: "master"  # Built from master branch
    pullPolicy: Always

  resources:
    requests:
      memory: "256Mi"
      cpu: "200m"
    limits:
      memory: "1Gi"
      cpu: "1000m"

  env:
    RUST_LOG: "info,synstack_api=info"

  secrets:
    # IMPORTANT: Generate these before deploying!
    # openssl rand -base64 32 | tr -d '\n'
    encryptionKey: "CHANGE-ME-GENERATE-WITH-OPENSSL"
    # Generate after Gitea is up with: kubectl exec -n synstack deploy/synstack-gitea ...
    giteaAdminToken: ""

  ingress:
    enabled: true
    className: traefik
    annotations:
      cert-manager.io/cluster-issuer: letsencrypt-prod
      traefik.ingress.kubernetes.io/router.middlewares: default-redirect-https@kubernetescrd
    hosts:
      - host: api.synstack.org  # Change to your domain
        paths:
          - path: /
            pathType: Prefix
    tls:
      - secretName: api-tls
        hosts:
          - api.synstack.org

  # Enable metrics for monitoring
  metrics:
    enabled: true

# =============================================================================
# PostgreSQL
# =============================================================================
postgresql:
  enabled: true

  image:
    tag: "latest"

  metrics:
    enabled: false  # TODO: fix exporter image tag

  auth:
    # IMPORTANT: Set a strong password!
    password: "CHANGE-ME-STRONG-PASSWORD"
    database: synstack
    username: synstack

  primary:
    # Create gitea database on init
    initdb:
      scripts:
        create-gitea-db.sql: |
          CREATE DATABASE gitea;

    persistence:
      enabled: true
      size: 20Gi

    resources:
      requests:
        memory: "512Mi"
        cpu: "250m"
      limits:
        memory: "2Gi"
        cpu: "1000m"

# =============================================================================
# Gitea
# =============================================================================
gitea:
  enabled: true

  gitea:
    admin:
      username: synstack-admin
      password: "CHANGE-ME-ADMIN-PASSWORD"
      email: admin@synstack.org

    config:
      APP_NAME: SynStack

      server:
        DOMAIN: git.synstack.org
        ROOT_URL: https://git.synstack.org
        SSH_DOMAIN: git.synstack.org
        SSH_PORT: 22
        LFS_START_SERVER: true

      service:
        DISABLE_REGISTRATION: true

      database:
        DB_TYPE: postgres
        HOST: synstack-postgresql:5432
        NAME: gitea
        USER: synstack
        PASSWD: "CHANGE-ME-STRONG-PASSWORD"

      ui:
        THEMES: gitea-light,gitea-dark,gitea-auto,synstack
        DEFAULT_THEME: synstack

      api:
        ENABLE_SWAGGER: true

  persistence:
    enabled: true
    size: 20Gi

  ingress:
    enabled: true
    className: traefik
    annotations:
      cert-manager.io/cluster-issuer: letsencrypt-prod
      traefik.ingress.kubernetes.io/router.middlewares: default-redirect-https@kubernetescrd
    hosts:
      - host: git.synstack.org
        paths:
          - path: /
            pathType: Prefix
    tls:
      - secretName: gitea-tls
        hosts:
          - git.synstack.org

  # Custom theme and templates
  extraVolumes:
    - name: gitea-custom-theme
      configMap:
        name: gitea-custom-theme

  postExtraInitContainers:
    - name: copy-custom-theme
      image: busybox:1.36
      command:
        - sh
        - -c
        - |
          mkdir -p /data/gitea/public/assets/css
          mkdir -p /data/gitea/public/assets/img
          mkdir -p /data/gitea/templates/custom
          cp /tmp/custom-theme/theme-synstack.css /data/gitea/public/assets/css/
          cp /tmp/custom-theme/logo.svg /data/gitea/public/assets/img/
          cp /tmp/custom-theme/favicon.svg /data/gitea/public/assets/img/
          cp /tmp/custom-theme/home.tmpl /data/gitea/templates/
          cp /tmp/custom-theme/header.tmpl /data/gitea/templates/custom/
          cp /tmp/custom-theme/footer.tmpl /data/gitea/templates/custom/
          cp /tmp/custom-theme/extra_links.tmpl /data/gitea/templates/custom/
          echo "Custom theme files copied successfully"
      volumeMounts:
        - name: gitea-custom-theme
          mountPath: /tmp/custom-theme
        - name: data
          mountPath: /data

# =============================================================================
# Global
# =============================================================================
global:
  storageClass: "local-path"  # k3s default storage class
