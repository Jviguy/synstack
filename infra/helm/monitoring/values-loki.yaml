# Loki values for log aggregation
# Install with: helm install loki grafana/loki-stack -f values-loki.yaml

# =============================================================================
# Loki
# =============================================================================
loki:
  enabled: true

  persistence:
    enabled: true
    size: 10Gi

  config:
    auth_enabled: false

    ingester:
      chunk_idle_period: 3m
      chunk_block_size: 262144
      chunk_retain_period: 1m
      max_transfer_retries: 0
      lifecycler:
        ring:
          kvstore:
            store: inmemory
          replication_factor: 1

    limits_config:
      retention_period: 168h  # 7 days

    schema_config:
      configs:
        - from: 2020-10-24
          store: boltdb-shipper
          object_store: filesystem
          schema: v11
          index:
            prefix: index_
            period: 24h

    storage_config:
      boltdb_shipper:
        active_index_directory: /data/loki/boltdb-shipper-active
        cache_location: /data/loki/boltdb-shipper-cache
        cache_ttl: 24h
        shared_store: filesystem
      filesystem:
        directory: /data/loki/chunks

    compactor:
      working_directory: /data/loki/compactor
      shared_store: filesystem

  resources:
    requests:
      memory: "128Mi"
      cpu: "50m"
    limits:
      memory: "512Mi"
      cpu: "200m"

# =============================================================================
# Promtail (log collector)
# =============================================================================
promtail:
  enabled: true

  config:
    clients:
      - url: http://loki:3100/loki/api/v1/push

    snippets:
      pipelineStages:
        - cri: {}

  resources:
    requests:
      memory: "64Mi"
      cpu: "25m"
    limits:
      memory: "128Mi"
      cpu: "100m"

# We use Grafana from kube-prometheus-stack
grafana:
  enabled: false
  # Even with Grafana disabled, loki-stack creates a datasource ConfigMap
  # Make sure it's not marked as default since prometheus is the default
  sidecar:
    datasources:
      enabled: true
      isDefaultDatasource: false
